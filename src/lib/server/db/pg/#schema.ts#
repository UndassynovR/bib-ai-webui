import {
  pgTable,
  text,
  varchar,
  index,
  uuid,
  boolean,
  timestamp,
} from "drizzle-orm/pg-core";

export const users = pgTable(
  "users",
  {
    id: uuid().primaryKey().$default(() => Bun.randomUUIDv7()),
    email: varchar({ length: 256 }).unique(),
    password_hash: varchar({ length: 256 }),
    name: varchar({ length: 256 }),
    is_guest: boolean().notNull().default(true),
    updated_at: timestamp().defaultNow(),
  },
  (table) => ({
    updated_at_idx: index("users_updated_at_idx").on(table.updated_at),
  })
);

export const sessions = pgTable(
  "sessions",
  {
    id: uuid().primaryKey().$default(() => Bun.randomUUIDv7()),
    user_id: uuid().notNull().references(() => users.id, { onDelete: 'cascade' }),
    token: varchar({ length: 256 }).unique().notNull(),
    expires_at: timestamp().notNull(),
    created_at: timestamp().defaultNow(),
  }
);

export const conversations = pgTable(
  "conversations",
  {
    id: uuid().primaryKey().$default(() => Bun.randomUUIDv7()),
    user_id: uuid()
      .notNull()
      .references(() => users.id, { onDelete: "cascade" }),
    title: varchar({ length: 256 }).notNull(),
    model: varchar({ length: 100 }).notNull(),
    updated_at: timestamp().defaultNow(),
  },
  (table) => ({
    user_id_idx: index("conversations_user_id_idx").on(table.user_id),
  })
);

export const messages = pgTable(
  "messages",
  {
    id: uuid().primaryKey().$default(() => Bun.randomUUIDv7()),
    conversation_id: uuid()
      .notNull()
      .references(() => conversations.id, { onDelete: "cascade" }),
    is_user: boolean().notNull(),
    content: text().notNull(),
  },
  (table) => ({
    conversation_id_idx: index("messages_conversation_id_idx").on(
      table.conversation_id
    ),
  })
);
