import { OPENAI_API_KEY } from "$env/static/private";
import { ChatOpenAI } from "@langchain/openai";
import { createAgent } from "langchain";
import { searchBooksTool } from "$lib/server/services/tools/searchBooks";

interface Message {
  role: string;
  content: string;
}

interface StreamChunk {
  delta: string;
  fullContent: string;
}

const model = new ChatOpenAI({
  apiKey: OPENAI_API_KEY,
  model: "gpt-4o",
  temperature: 0.1,
  streaming: true,
});

const agent = await createAgent({
  model,
  tools: [searchBooksTool],
});

export async function* streamChatCompletion(
  messages: Message[]
): AsyncGenerator<StreamChunk> {
  let fullContent = "";

  // Agent stream call
  for await (const [token, metadata] of await agent.stream(
    { messages },
    { streamMode: "messages" }
  )) {
    // token.contentBlocks is an array; we join the text blocks into a delta string
    const delta = token.contentBlocks?.map((b: any) => b.text).join("") || "";

    if (delta) {
      fullContent += delta;
      yield { delta, fullContent };
    }
  }
}

export async function generateConversationTitle(message: string): Promise<string> {
  console.log('generateConversationTitle called with message:', message.substring(0, 100));

  // Simple greeting check (case-insensitive)
  const greetings = ["hi", "hello", "hey", "good morning", "good afternoon", "good evening"];
  const normalized = message.trim().toLowerCase();
  if (greetings.includes(normalized)) {
    return "New chat";
  }

  try {
    const model = new ChatOpenAI({
      apiKey: OPENAI_API_KEY,
      model: "gpt-4o-mini",
      temperature: 0.7,
      maxTokens: 30,
    });

    console.log('Invoking OpenAI for title generation...');
    const response = await model.invoke([
      {
        role: "system",
        content: "Generate a concise, descriptive title (max 50 characters) for a conversation. Return ONLY the title, no quotes, explanations, or extra text."
      },
      {
        role: "user",
        content: `Generate a title for a conversation that starts with: "${message}"`
      }
    ]);

    let title = response.content.toString().trim().replace(/^["']|["']$/g, '');
    console.log('AI generated title:', title);

    // Ensure it's not too long
    if (title.length > 50) {
      return title.substring(0, 47) + '...';
    }

    return title || message.substring(0, 47) + '...';
  } catch (error) {
    console.error('Failed to generate title:', error);
    // Fallback: use first part of message
    return message.substring(0, 47) + (message.length > 47 ? '...' : '');
  }
}
