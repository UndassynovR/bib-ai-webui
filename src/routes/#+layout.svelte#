<script lang="ts">
  import '../app.css';
  import { browser } from '$app/environment';
  import { chatStore } from '$lib/stores/chatStore.svelte';
  import Sidebar from '$lib/components/Sidebar.svelte';
  import Nav from '$lib/components/Nav.svelte';
  import { onMount } from 'svelte';

  let sidebarOpen = false;
  let isWideScreen = false;

  // Track screen size
  function checkWidth() {
    if (!browser) return;
    isWideScreen = window.innerWidth > 700;
  }

  onMount(() => {
    if (!browser) return;
    checkWidth();
    window.addEventListener('resize', checkWidth);
    chatStore.loadConversations();
    return () => window.removeEventListener('resize', checkWidth);
  });

  function toggleSidebar() {
    sidebarOpen = !sidebarOpen;
  }

  function handleNewChat() {
    chatStore.startNewChat();
    if (!isWideScreen) sidebarOpen = false;
  }

  async function handleConversationClick(id: string) {
    await chatStore.selectConversation(id);
    if (!isWideScreen) sidebarOpen = false;
  }
</script>

<div class="layout">
  <Nav
    {isWideScreen}
    {sidebarOpen}
    onToggle={toggleSidebar}
  />
  <Sidebar
    {sidebarOpen}
    {isWideScreen}
    onToggle={toggleSidebar}
    onNewChat={handleNewChat}
    onSelectConversation={handleConversationClick}
  />
  <main
    class="content"
    style="margin-left: {isWideScreen ? (sidebarOpen ? '260px' : '60px') : '0'}"
  >
    <slot />
  </main>
</div>

<style>
  .layout {
    display: flex;
    min-height: 100vh;
    background: white;
  }
  .content {
    flex: 1;
    transition: margin-left 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    display: flex;
    flex-direction: column;
    position: relative;
    height: 100vh;
    overflow: hidden;
    padding-top: 0; /* optional if your Nav is fixed */
  }
  
  @media (max-width: 700px) {
    .content {
      padding-top: 3.5rem; /* space for Nav if needed */
      margin-left: 0 !important;
    }
  }
</style>